# INFINITAS バージョン 2026012800 のメモリ構造変更

beatmania IIDX INFINITAS バージョン `P2D:J:B:A:2026012800` で発見された重要なメモリレイアウト変更について記述します。

## 概要

楽曲エントリ構造が **1008 バイト** から **1200 バイト** に拡張され、192 バイト（64 バイトフィールド × 3）が追加されました。これにより、楽曲メタデータ読み取りのオフセット計算がすべて影響を受けます。

## 主要な変更点

### エントリサイズ

| バージョン | エントリサイズ | 16進数 |
|-----------|--------------|--------|
| 旧 (2026012800 未満) | 1008 バイト | 0x3F0 |
| **新 (2026012800 以降)** | **1200 バイト** | **0x4B0** |

### オフセット変更

| フィールド | 旧オフセット | 新オフセット | 差分 |
|-----------|-------------|-------------|------|
| title | 0 | 0 | - |
| title_english | 64 | 64 | - |
| genre | 128 | 128 | - |
| artist | 192 | 192 | - |
| folder | 280 | **472** | +192 |
| levels (10 バイト) | 288 | **480** | +192 |
| bpm | 320 | **512** | +192 |
| notes (40 バイト) | 432 | **624** | +192 |
| song_id | 624 | **816** | +192 |

### メモリレイアウト比較

#### 旧構造 (1008 バイト)

```
オフセット  サイズ  フィールド
---------  ------  ----------
0x000      64      title (Shift-JIS)
0x040      64      title_english (Shift-JIS)
0x080      64      genre (Shift-JIS)
0x0C0      64      artist (Shift-JIS)
0x100      88      メタデータセクション
0x118      1       folder
0x120      10      levels[10] (難易度)
0x140      8       bpm (max, min)
0x1B0      40      total_notes[10]
0x270      4       song_id
...
0x3F0      -       (エントリ終端)
```

#### 新構造 (1200 バイト)

```
オフセット  サイズ  フィールド
---------  ------  ----------
0x000      64      title (Shift-JIS)
0x040      64      title_english (Shift-JIS)
0x080      64      genre (Shift-JIS)
0x0C0      64      artist (Shift-JIS)
0x100      192     追加フィールド (64 バイト × 3、用途不明)
0x1C0      32      メタデータセクション
0x1D8      1       folder (推定)
0x1E0      10      levels[10] (難易度)
0x200      8       bpm (max, min) (推定)
0x270      40      total_notes[10] (推定)
0x330      4       song_id
...
0x4B0      -       (エントリ終端)
```

## 発見プロセス

### 初期症状

1. トラッカーが実際のタイトル "fun" ではなく "Song 09003" と表示
2. レベルが正しい値（SPA は 10）ではなく 0 と表示
3. song_id は `current_song` オフセットから正しく読み取れていたが、楽曲情報の検索に失敗

### 調査手順

1. **文字列検索**: メモリ内で "fun\0" 文字列を検索
   - アドレス `0x1431B08A0` で発見

2. **song_id 検索**: 値 9003 (0x232B) を 4 バイト整数として検索
   - アドレス `0x1431B0BD0` で発見
   - "fun" 文字列からのオフセット: **816 バイト**

3. **レベルパターン検索**: 値 0-12 の連続する 10 バイトをスキャン
   - タイトルからオフセット **480** の位置で `[0, 4, 7, 10, 0, 0, 4, 7, 10, 0]` を発見

4. **エントリサイズ検証**: 1200 バイトのエントリサイズでテスト
   - **1658 曲** の検出に成功（旧 1008 バイトでは 80 曲のみ）
   - すべての song_id とレベル値が正しく一致

### 例: "fun" エントリの解析

```
アドレス 0x1431B08A0 (エントリ開始):
  オフセット   0: title = "fun"
  オフセット  64: title_english = (空)
  オフセット 128: genre = "FUNK SHUFFLE"
  オフセット 192: artist = "Mr.T"
  オフセット 256-447: 追加フィールド (用途不明)
  オフセット 480: levels = [0, 4, 7, 10, 0, 0, 4, 7, 10, 0]
  オフセット 816: song_id = 9003
```

## コード変更

### `crates/reflux-core/src/game/song.rs`

```rust
impl SongInfo {
    // 旧
    // pub const MEMORY_SIZE: usize = 0x3F0;  // 1008 バイト
    // const LEVELS_OFFSET: usize = 288;
    // const SONG_ID_OFFSET: usize = 624;

    // 新 (バージョン 2026012800 以降)
    pub const MEMORY_SIZE: usize = 0x4B0;     // 1200 バイト
    const LEVELS_OFFSET: usize = 480;
    const SONG_ID_OFFSET: usize = 816;
}
```

## 同時に行われたその他の修正

### シグネチャパターンの更新

新バイナリ (bm2dx-2.exe) で一部のシグネチャ検索が機能しなかったため、新旧両方のバイナリで動作するパターンに更新しました。

- **変更ファイル**: `crates/reflux-core/src/offset/signature.rs`
- **変更定数**: `JUDGE_TO_CURRENT_SONG` を `0x160` から `0x1E4` に更新

### ResultScreen 状態検出の修正

トラッカー開始時に既に ResultScreen にいる場合の検出ができていなかった問題を解決しました。

- **変更ファイル**: `crates/reflux-core/src/game/state.rs`
- **変更内容**: `detect_raw()` ロジックを C# 本家実装に合わせて修正

### PlaySettings 検索の改善

PlaySettings オフセット検索パターンを C# 本家実装と完全に一致させました。

- **変更ファイル**: `crates/reflux-core/src/offset/searcher/mod.rs`
- **変更内容**: 20 バイトの固定パターン検索、gauge 値の判定を EXHARD=4/EASY=2 に統一

## 互換性に関する注意

- この変更は INFINITAS バージョン `P2D:J:B:A:2026012800` 以降に適用されます
- 旧バージョンでは依然として 1008 バイト構造を使用している可能性があります
- 将来のバージョンでは追加調査が必要になる可能性があります

## 補足事項

### 遅延読み込み

新バージョンでは楽曲が song_list に遅延読み込みされます。メモリスキャン時:
- 空エントリがリスト全体に散在
- ゲーム内でアクセスするまですべての楽曲が読み込まれるわけではない
- `fetch_song_by_id` 関数は楽曲を見つけるために最大 5000 エントリをスキャン

### オフセットファイル

`--offsets-file` を使用する場合、以下のオフセットが必要です:

```
P2D:J:B:A:2026012800
songList = 0x1431865a0
judgeData = 0x1428380ec
playData = 0x14258b3e4
playSettings = 0x14258b144
currentSong = 0x1428382d0
```

## 参考資料

- オリジナル C# Reflux: `.agent/Reflux/Reflux/Utils.cs` (FetchSongInfo 関数)
- メモリ探索ツール: `cargo run --release -- explore --address <addr>`
